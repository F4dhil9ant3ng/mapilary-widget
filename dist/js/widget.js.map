{"version":3,"sources":["src/script/widget.es6.js"],"names":[],"mappings":"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","file":"src/script/widget.es6.js","sourcesContent":["class MapilaryWidget {\n\n\tconstructor(_settings) {\n\t\tthis._titles = 0\n\t\tthis._trackings = {}\n\n\t\t//# Merge default settings with settings.\n\t\tthis._settings = $.extend({}, this.constructor._defaults, _settings)\n\t\tthis._$el = $(this._settings.el)\n\t}\n\n\trender() {\n\t\tvar settings = this._settings\n\t\tvar $el = this._$el\n\n\t\tvar $widget = this._$el.clone()\n\t\t$widget.empty()\n\t\t$widget.addClass('mapilary-widget')\n\t\tthis._$el = $widget\n\n\t\tif (settings.trackForm) {\n\t\t\t$widget.append(this._renderTrackForm())\n\t\t}\n\t\t$widget.append(this.constructor._mapTpl)\n\n\t\tthis._map = L.map($widget.find('.map')[0])\n\t\t\t.setView(settings.center, settings.zoom)\n\t\tthis._featureGroup = L.featureGroup()\n\t\tL.tileLayer(settings.tilesUrl, {\n\t\t\tattribution: settings.attribution,\n\t\t\tmaxZoom: settings.maxZoom\n\t\t}).addTo(this._map)\n\t\tL.control.locate().addTo(this._map)\n\t\tthis._featureGroup.addTo(this._map)\n\n\t\tif (settings.trackingNr) {\n\t\t\tthis.trackDelivery(settings.trackingNr)\n\t\t\t\t.done(() => {\n\t\t\t\t\t$el.replaceWith($widget)\n\t\t\t\t\tthis.invalidateSize()\n\t\t\t\t})\n\t\t\treturn\n\t\t}\n\n\t\t$el.replaceWith($widget)\n\t\tthis.invalidateSize()\n\t\treturn this\n\t}\n\n\tinvalidateSize() {\n\t\tvar mapHeight = this._$el.height() - this._$el.find('.tracking-form').outerHeight(true) - 2\n\t\tthis._$el.find('.map-container').height(mapHeight)\n\t\tthis._map.invalidateSize()\n\t}\n\n\t_renderTrackForm() {\t\n\t\tvar $el = $(this.constructor._trackFormTpl)\n\t\t$el.find('button:submit').on('click', (ev) => {\n\t\t\tev.preventDefault()\n\t\t\tvar trackingNr = $(ev.target.form[0]).val().toUpperCase()\n\t\t\tthis.trackDelivery(trackingNr)\n\t\t})\n\t\treturn $el\n\t}\n\t\n\t_socketConnect(trackingNr) {\n\t\tvar driver = null\n\t\tvar socket = io.connect(this._settings.wsUrl, { path: '/socket.io' })\n\t\tsocket.on('connect', () => {\n\t\t\tsocket.emit('subscribe', 'trackingNr:' + trackingNr)\n\t\t})\n\t\tsocket.on('position:update', (pos) => {\n\t\t\tvar coords = pos.coords\n\t\t\tvar latlng = new L.LatLng(coords.latitude, coords.longitude)\n\t\t\tif (!driver) {\n\t\t\t\tdriver = L.marker(latlng, {\n\t\t\t\t\ticon: L.icon({\n\t\t\t\t\t\ticonUrl: 'images/driver-marker.png',\n\t\t\t\t\t\ticonSize: [40, 54],\n\t\t\t\t\t\ticonAnchor: [20, 54]\n\t\t\t\t\t})\n\t\t\t\t})\n\t\t\t\tthis._featureGroup.addLayer(driver)\n\t\t\t\tthis._map.fitBounds(this._featureGroup, { padding: [15, 15] })\n\t\t\t} else {\n\t\t\t\tdriver.setLatLng(latlng)\n\t\t\t}\n\t\t})\n\t}\n\n\ttrackDelivery(trackingNr, callback) {\n\t\tif (!trackingNr) {\n\t\t\talert('Please enter a tracking number to proceed');\n\t\t\treturn\n\t\t}\n\t\tvar $el = this._$el\n\t\tvar url = this._settings.deliveryServiceUrl.replace('{trackingNr}', trackingNr)\n\t\t$.get(url, (deliveries) => {\n\t\t\tvar delivery = deliveries.length && deliveries[0] || null\n\t\t\tif (!delivery) {\n\t\t\t\talert('No delivery found with the tracking number: ' + trackingNr)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tif (!(delivery.addresses && delivery.addresses.length > 0)) {\n\t\t\t\talert('Delivery has no drop address.')\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tvar coords = delivery.addresses[0].coords\n\t\t\tdelivery.latlng = new L.LatLng(coords.latitude, coords.longitude)\n\n\t\t\t$el.addClass('is-tracking')\n\n\t\t\tthis._map.panTo(delivery.latlng)\n\n\t\t\tvar userMarker = L.marker(delivery.latlng, {\n\t\t\t\ticon: L.icon({\n\t\t\t\t\ticonUrl: 'images/user-marker.png',\n\t\t\t\t\ticonSize: [40, 54],\n\t\t\t\t\ticonAnchor: [20, 54]\n\t\t\t\t})\n\t\t\t})\n\t\t\tthis._featureGroup.addLayer(userMarker)\n\n\t\t\tthis._socketConnect(trackingNr)\n\n\t\t\t//# info-overlay stuff\n\t\t\tvar $overlay = $el.find('.info-overlay')\n\t\t\t$overlay.show()\n\t\t\tthis._trackings[trackingNr] = {\n\t\t\t\tetd: delivery.etd\n\t\t\t}\n\t\t\tif (delivery.etd) {\n\t\t\t\teta = new Date(delivery.etd.date)\n\t\t\t\t$overlay.find('.eta .dynamic')\n\t\t\t\t\t.html([eta.getHours(), eta.getMinutes()]\n\t\t\t\t\t.join(':'))\n\t\t\t\t$overlay.find('.client-position .dynamic').html(delivery.etd.orderNr)\n\t\t\t}\n\n\t\t\t$overlay.find('.info').html(delivery.note)\n\t\t})\n\t}\n}\n\n//# Default settings\nMapilaryWidget._defaults = {\n\tallowedTravelModes: 'CAR',\n\tunitSystem: 'METRIC',\n\twsUrl: 'https://ws.mapilary.com:443',\n\tdeliveryServiceUrl: 'https://api.mapilary.com/v1/deliveries/find?trackingNr={trackingNr}',\n\tfindPathUrl: 'http://ec2-54-194-157-122.eu-west-1.compute.amazonaws.com/pathfinding/',\n\ttilesUrl: 'http://{s}.tiles.mapbox.com/v3/mapilary.hmal3hg1/{z}/{x}/{y}.png',\n\tattribution: '&copy; <a href=\\\"http://www.mapbox.com\\\">Mapbox</a>',\n\tcenter: [51.505, -0.09],\n\tzoom: 13,\n\tmaxZoom: 18,\n\ttrackForm: true\n}\n\nMapilaryWidget._trackFormTpl = '<form class=\"tracking-form\" class=\"form-inline\" role=\"form\"><div><div class=\"form-group\"><input type=\"text\" name=\"trackingNr\" class=\"trackingNr form-control\" title=\"for demonstration enter DEMO as Tracking Nr.\" placeholder=\"Tracking Nr.\" autofocus></div><button class=\"btn btn-default btn-track\" data-toggle=\"collapse\" data-target=\".bs-widget-frame\" type=\"submit\">TRACK</button></div></form>'\nMapilaryWidget._mapTpl = '<div class=\"map-container\"><div class=\"info-overlay\" style=\"display:none\"><div class=\"eta\"><b>ETA</b> <span class=\"dynamic\"></span></div><div class=\"info\"></div><div class=\"client-position\"><div><span>#<b class=\"dynamic\"></b></span></div><div class=\"text\">Waiting list position</div></div></div><div class=\"map\"></div></div>'\n\n\nif (typeof module != 'undefined')\n\tmodule.exports = MapilaryWidget\nelse\n\twindow.MapilaryWidget = MapilaryWidget"]}