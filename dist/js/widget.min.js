"use strict";var _createClass=function(){function a(a,b){for(var c in b){var d=b[c];d.configurable=!0,d.value&&(d.writable=!0)}Object.defineProperties(a,b)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),_classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},MapilaryWidget=function(){function a(b){_classCallCheck(this,a),this._titles=0,this._trackings={},this._settings=$.extend({},this.constructor._defaults,b),this._$el=$(this._settings.el)}return _createClass(a,{render:{value:function(){var a=this,b=this._settings,c=this._$el,d=this._$el.clone();return d.empty(),d.addClass("mapilary-widget"),this._$el=d,b.trackForm&&d.append(this._renderTrackForm()),d.append(this.constructor._mapTpl),this._map=L.map(d.find(".map")[0]).setView(b.center,b.zoom),this._featureGroup=L.featureGroup(),L.tileLayer(b.tilesUrl,{attribution:b.attribution,maxZoom:b.maxZoom}).addTo(this._map),L.control.locate().addTo(this._map),this._featureGroup.addTo(this._map),b.trackingNr?void this.trackDelivery(b.trackingNr).done(function(){c.replaceWith(d),a.invalidateSize()}):(c.replaceWith(d),this.invalidateSize(),this)}},invalidateSize:{value:function(){var a=this._$el.height()-this._$el.find(".tracking-form").outerHeight(!0)-2;this._$el.find(".map-container").height(a),this._map.invalidateSize()}},_renderTrackForm:{value:function(){var a=this,b=$(this.constructor._trackFormTpl);return b.find("button:submit").on("click",function(b){b.preventDefault();var c=$(b.target.form[0]).val().toUpperCase();a.trackDelivery(c)}),b}},_socketConnect:{value:function(a){var b=this,c=null,d=io.connect(this._settings.wsUrl,{path:this._settings.wsPath});d.on("connect",function(){d.emit("subscribe","trackingNr:"+a)}),d.on("position:update",function(a){var d=a.coords,e=new L.LatLng(d.latitude,d.longitude);c?c.setLatLng(e):(c=L.marker(e,{icon:L.icon({iconUrl:"images/driver-marker.png",iconSize:[40,54],iconAnchor:[20,54]})}),b._featureGroup.addLayer(c),b._map.fitBounds(b._featureGroup,{padding:[15,15]}))})}},trackDelivery:{value:function(a){var b=this;if(!a)return void alert("Please enter a tracking number to proceed");var c=this._$el,d=this._settings.deliveryServiceUrl.replace("{trackingNr}",a);$.get(d,function(d){var e=d.length&&d[0]||null;if(!e)return void alert("No delivery found with the tracking number: "+a);if(!(e.addresses&&e.addresses.length>0))return void alert("Delivery has no drop address.");var f=e.addresses[0].coords;e.latlng=new L.LatLng(f.latitude,f.longitude),c.addClass("is-tracking"),b._map.panTo(e.latlng);var g=L.marker(e.latlng,{icon:L.icon({iconUrl:"images/user-marker.png",iconSize:[40,54],iconAnchor:[20,54]})});b._featureGroup.addLayer(g),b._socketConnect(a);var h=c.find(".info-overlay");h.show(),b._trackings[a]={etd:e.etd},e.etd&&(eta=new Date(e.etd.date),h.find(".eta .dynamic").html([eta.getHours(),eta.getMinutes()].join(":")),h.find(".client-position .dynamic").html(e.etd.orderNr)),h.find(".info").html(e.note)})}}}),a}();MapilaryWidget._defaults={allowedTravelModes:"CAR",unitSystem:"METRIC",wsUrl:"https://ws.mapilary.com:443",wsPath:"/socket.io",deliveryServiceUrl:"https://api.mapilary.com/v1/deliveries/find?trackingNr={trackingNr}",findPathUrl:"http://ec2-54-194-157-122.eu-west-1.compute.amazonaws.com/pathfinding/",tilesUrl:"http://{s}.tiles.mapbox.com/v3/mapilary.hmal3hg1/{z}/{x}/{y}.png",attribution:'&copy; <a href="http://www.mapbox.com">Mapbox</a>',center:[51.505,-.09],zoom:13,maxZoom:18,trackForm:!0},MapilaryWidget._trackFormTpl='<form class="tracking-form" class="form-inline" role="form"><div><div class="form-group"><input type="text" name="trackingNr" class="trackingNr form-control" title="for demonstration enter DEMO as Tracking Nr." placeholder="Tracking Nr." autofocus></div><button class="btn btn-default btn-track" data-toggle="collapse" data-target=".bs-widget-frame" type="submit">TRACK</button></div></form>',MapilaryWidget._mapTpl='<div class="map-container"><div class="info-overlay" style="display:none"><div class="eta"><b>ETA</b> <span class="dynamic"></span></div><div class="info"></div><div class="client-position"><div><span>#<b class="dynamic"></b></span></div><div class="text">Waiting list position</div></div></div><div class="map"></div></div>',"undefined"!=typeof module?module.exports=MapilaryWidget:window.MapilaryWidget=MapilaryWidget;