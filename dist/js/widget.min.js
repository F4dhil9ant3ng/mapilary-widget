(function(){var a;a=function(){function a(a){this._titles=0,this._trackings={},this._settings=$.extend({},this.constructor._defaults,a),this._$el=$(this._settings.el)}return a._defaults={allowedTravelModes:"CAR",unitSystem:"METRIC",wsUrl:"https://ws.mapilary.com:443",deliveryServiceUrl:"https://api.mapilary.com/v1/deliveries/find?trackingNr={trackingNr}",findPathUrl:"http://ec2-54-194-157-122.eu-west-1.compute.amazonaws.com/pathfinding/",tilesUrl:"http://{s}.tiles.mapbox.com/v3/mapilary.hmal3hg1/{z}/{x}/{y}.png",attribution:'&copy; <a href="http://www.mapbox.com">Mapbox</a>',center:[51.505,-.09],zoom:13,maxZoom:18,trackForm:!0},a._trackFormTpl='<form class="tracking-form" class="form-inline" role="form"><div><div class="form-group"><input type="text" name="trackingNr" class="trackingNr form-control" title="for demonstration enter DEMO as Tracking Nr." placeholder="Tracking Nr." autofocus></div><button class="btn btn-default btn-track" data-toggle="collapse" data-target=".bs-widget-frame" type="submit">TRACK</button></div></form>',a._mapTpl='<div class="map-container"><div class="info-overlay" style="display:none"><div class="eta"><b>ETA</b> <span class="dynamic"></span></div><div class="info"></div><div class="client-position"><div><span>#<b class="dynamic"></b></span></div><div class="text">Waiting list position</div></div></div><div class="map"></div></div>',a.prototype.render=function(){var a,b,c;return c=this._settings,a=this._$el,b=this._$el.clone(),b.empty(),b.addClass("mapilary-widget"),this._$el=b,c.trackForm&&b.append(this._renderTrackForm()),b.append(this.constructor._mapTpl),this._map=L.map(b.find(".map")[0]).setView(c.center,c.zoom),this._featureGroup=L.featureGroup(),L.tileLayer(c.tilesUrl,{attribution:c.attribution,maxZoom:c.maxZoom}).addTo(this._map),L.control.locate().addTo(this._map),this._featureGroup.addTo(this._map),c.trackingNr?void this.trackDelivery(c.trackingNr).done(function(c){return function(){return a.replaceWith(b),c.invalidateSize()}}(this)):(a.replaceWith(b),this.invalidateSize(),this)},a.prototype.invalidateSize=function(){var a;return a=this._$el.height()-this._$el.find(".tracking-form").outerHeight(!0)-2,this._$el.find(".map-container").height(a),this._map.invalidateSize()},a.prototype._renderTrackForm=function(){var a;return a=$(this.constructor._trackFormTpl),a.find("button:submit").on("click",function(a){return function(b){var c;return b.preventDefault(),c=$(b.target.form[0]).val().toUpperCase(),a.trackDelivery(c)}}(this)),a},a.prototype._socketConnect=function(a){var b,c;return b=null,c=io.connect(this._settings.wsUrl,{resource:"socket.io"}),c.on("connect",function(){return c.emit("subscribe","trackingNr:"+a)}),c.on("position:update",function(a){return function(c){var d;return d=new L.LatLng(c.latitude,c.longitude),b?b.setLatLng(d):(b=L.marker(d,{icon:L.icon({iconUrl:"images/driver-marker.png",iconSize:[40,54],iconAnchor:[20,54]})}),a._featureGroup.addLayer(b),a._map.fitBounds(a._featureGroup,{padding:[15,15]}))}}(this))},a.prototype.trackDelivery=function(a){var b,c;return a?(b=this._$el,c=this._settings.deliveryServiceUrl.replace("{trackingNr}",a),$.get(c,function(c){return function(d){var e,f,g,h,i;return(g=d.length&&d[0]||null)?g.addresses&&g.addresses.length>0?(f=g.addresses[0].coords,g.latlng=new L.LatLng(f.latitude,f.longitude),b.addClass("is-tracking"),c._map.panTo(g.latlng),i=L.marker(g.latlng,{icon:L.icon({iconUrl:"images/user-marker.png",iconSize:[40,54],iconAnchor:[20,54]})}),c._featureGroup.addLayer(i),c._socketConnect(a),e=b.find(".info-overlay"),e.show(),c._trackings[a]={etd:g.etd},g.etd&&(h=new Date(g.etd.date),e.find(".eta .dynamic").html([h.getHours(),h.getMinutes()].join(":")),e.find(".client-position .dynamic").html(g.etd.orderNr)),e.find(".info").html(g.note)):void alert("Delivery has no drop address."):void alert("No delivery found with the tracking number: "+a)}}(this))):void alert("Please enter a tracking number to proceed")},a}(),"undefined"!=typeof module?module.exports=a:this.MapilaryWidget=a}).call(this);